# GitLab CI/CD configuration for KubeChargeback
# This pipeline automates the lifecycle of the application: building, testing, and containerization.

# 1. Pipeline Stages
# Defines the execution order of jobs. Jobs in the same stage run in parallel.
stages:
  - build    # Compile code and build frontend assets
  - test     # Run unit and integration tests
  - package  # Build and tag Docker images

# 2. Global Variables
variables:
  # Tell Maven to use a local repository within the project directory for better caching
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/kube-chargeback/.m2/repository"
  # Configuration for Docker-in-Docker (DinD)
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

# 3. Global Cache
# Caching speeds up builds by persisting dependencies between pipeline runs.
cache:
  # Use the branch/merge request slug as the key so each branch has its own cache
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - kube-chargeback/.m2/repository         # Java/Maven dependencies
    - kube-chargeback/chargeback-ui/node_modules/ # Node.js/npm dependencies

# --- Build Stage ---

build-backend:
  stage: build
  image: eclipse-temurin:21-jdk
  script:
    - cd kube-chargeback
    - ./mvnw clean package -DskipTests # Build the JAR without running tests yet
  artifacts:
    # Save the build results so they can be used in the 'package' stage
    paths:
      - "kube-chargeback/*/target/*.jar"
      - "kube-chargeback/*/target/quarkus-app/"
    expire_in: 1 hour

build-frontend:
  stage: build
  image: node:20
  script:
    - cd kube-chargeback/chargeback-ui
    - npm install
    - npm run build # Generate the 'dist' folder for Nginx
  artifacts:
    paths:
      - kube-chargeback/chargeback-ui/dist/
    expire_in: 1 hour

# --- Test Stage ---

test-backend:
  stage: test
  image: eclipse-temurin:21-jdk
  script:
    - cd kube-chargeback
    - ./mvnw test # Run all Quarkus tests
  artifacts:
    # Always save test reports, even if the tests fail
    when: always
    reports:
      junit:
        - "kube-chargeback/*/target/surefire-reports/TEST-*.xml"

test-frontend:
  stage: test
  image: node:20
  script:
    - cd kube-chargeback/chargeback-ui
    - npm install
    # - npm test # Placeholder: Run frontend tests once implemented
  allow_failure: true # Don't block the pipeline if frontend tests fail (for now)

# --- Package Stage (Docker) ---

# Template for Docker jobs to avoid repetition
.docker-setup:
  image: docker:24.0.5
  services:
    # Enables building images inside the runner
    - docker:24.0.5-dind
  before_script:
    - docker info
    # To enable pushing, you would need to run 'docker login' here using CI secrets

docker-api:
  extends: .docker-setup
  stage: package
  script:
    - cd kube-chargeback
    # Build the JVM-based container for the API
    docker build -f chargeback-api/src/main/docker/Dockerfile.jvm -t $CI_REGISTRY_IMAGE/api:$CI_COMMIT_REF_SLUG .
  only:
    - main           # Only build for the main branch
    - merge_requests # and for merge requests

docker-collector:
  extends: .docker-setup
  stage: package
  script:
    - cd kube-chargeback
    # Build the JVM-based container for the Collector
    docker build -f chargeback-collector/src/main/docker/Dockerfile.jvm -t $CI_REGISTRY_IMAGE/collector:$CI_COMMIT_REF_SLUG .
  only:
    - main
    - merge_requests

docker-ui:
  extends: .docker-setup
  stage: package
  script:
    - cd kube-chargeback
    # Build the Nginx-based container for the React frontend
    docker build -t $CI_REGISTRY_IMAGE/ui:$CI_COMMIT_REF_SLUG chargeback-ui
  only:
    - main
    - merge_requests
